# P.I.D.R. WebSocket Server

–ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –¥–ª—è –∫–∞—Ä—Ç–æ—á–Ω–æ–π –∏–≥—Ä—ã P.I.D.R. —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π WebSocket, –∫–æ–º–Ω–∞—Ç, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–≥—Ä–æ–∫–æ–≤ –∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

## üöÄ –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º (Linux/Mac)
chmod +x start.sh

# –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
./start.sh dev

# –ó–∞–ø—É—Å–∫ –≤ –ø—Ä–æ–¥–∞–∫—à–Ω —Ä–µ–∂–∏–º–µ
./start.sh
```

### –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

1. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:**
```bash
npm install
```

2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
```bash
cp .env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
```

3. **–ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞:**
```bash
# –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞
npm run dev

# –ü—Ä–æ–¥–∞–∫—à–Ω
npm start
```

## üì° API Endpoints

### WebSocket
- **–ü—É—Ç—å:** `/api/socket`
- **–°–æ–±—ã—Ç–∏—è:** `join-room`, `leave-room`, `game-state-update`, `player-move`, etc.

### HTTP API
- `POST /api/rooms/create` - –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
- `POST /api/rooms/join` - –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ
- `GET /api/stats/:userId` - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–∞
- `GET /api/history/:userId` - –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä
- `GET /api/leaderboard` - –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤
- `GET /api/health` - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–µ—Ä–∞

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **GameRoomManager** - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–≤—ã–º–∏ –∫–æ–º–Ω–∞—Ç–∞–º–∏
2. **Database** - SQLite –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
3. **PlayerStatsManager** - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–≥—Ä–æ–∫–æ–≤
4. **WebSocket Server** - Socket.io –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–°–µ—Ä–≤–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç SQLite –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏:

- `players` - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–≥—Ä–æ–∫–∞—Ö
- `games` - –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä
- `game_participations` - –£—á–∞—Å—Ç–∏–µ –∏–≥—Ä–æ–∫–æ–≤ –≤ –∏–≥—Ä–∞—Ö
- `player_stats` - –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- `achievements` - –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤

## üéÆ –ò–≥—Ä–æ–≤–∞—è –ª–æ–≥–∏–∫–∞

### –ö–æ–º–Ω–∞—Ç—ã
- **–ú–∞–∫—Å–∏–º—É–º –∏–≥—Ä–æ–∫–æ–≤:** 4-8 (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
- **–ö–æ–¥—ã –∫–æ–º–Ω–∞—Ç:** 6-—Å–∏–º–≤–æ–ª—å–Ω—ã–µ –∫–æ–¥—ã –¥–ª—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞:** –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã —É–¥–∞–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- **–†–µ–π—Ç–∏–Ω–≥:** ELO-–ø–æ–¥–æ–±–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞
- **–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
- **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞:** –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∏–≥—Ä–∞–º

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
# –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
PORT=3001
CORS_ORIGIN=http://localhost:3000,https://t.me

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
DATABASE_PATH=./pidr_game.db

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–Ω–∞—Ç
MAX_ROOMS=1000
ROOM_CLEANUP_INTERVAL=300000
ROOM_TIMEOUT_MINUTES=30

# –†–µ–π—Ç–∏–Ω–≥
BASE_RATING=1000
MIN_RATING=100
MAX_RATING_CHANGE=50
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS –¥–ª—è Telegram

–î–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram WebApp –¥–æ–±–∞–≤—å—Ç–µ –¥–æ–º–µ–Ω—ã –≤ `CORS_ORIGIN`:

```env
CORS_ORIGIN=https://yourdomain.com,https://t.me
```

## üîß –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤
```
server/
‚îú‚îÄ‚îÄ server.js              # –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä
‚îú‚îÄ‚îÄ gameRoomManager.js      # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç–∞–º–∏
‚îú‚îÄ‚îÄ database.js             # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ playerStatsManager.js   # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
‚îú‚îÄ‚îÄ package.json            # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ start.sh               # –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞
‚îî‚îÄ‚îÄ README.md              # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–µ—Ä–≤–µ—Ä –≤—ã–≤–æ–¥–∏—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ —Å —ç–º–æ–¥–∑–∏ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞:
- üîå WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- üè† –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç–∞–º–∏
- üíæ –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- üéÆ –ò–≥—Ä–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è

### –û—Ç–ª–∞–¥–∫–∞

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–µ—Ä–∞:**
```bash
curl http://localhost:3001/api/health
```

2. **–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:**
```bash
npm run dev
```

## üåê –î–µ–ø–ª–æ–π

### Docker (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install --production
COPY . .
EXPOSE 3001
CMD ["npm", "start"]
```

### PM2

```bash
npm install -g pm2
pm2 start server.js --name "pidr-server"
pm2 save
pm2 startup
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ú–µ—Ç—Ä–∏–∫–∏
- –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã: `/api/health`
- –ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã: Socket.io —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã

### –õ–æ–≥–∏
- –ö–æ–Ω—Å–æ–ª—å–Ω—ã–µ –ª–æ–≥–∏ —Å —Ü–≤–µ—Ç–æ–≤–æ–π –∏–Ω–¥–∏–∫–∞—Ü–∏–µ–π
- –§–∞–π–ª –ª–æ–≥–æ–≤: `./logs/server.log` (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **Rate Limiting** - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
2. **CORS** - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –¥–æ–º–µ–Ω—ã
3. **Input Validation** - –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
4. **SQL Injection** - –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

## üö® –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

1. **–ü–æ—Ä—Ç –∑–∞–Ω—è—Ç:**
```bash
lsof -i :3001
kill -9 <PID>
```

2. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞:**
```bash
rm pidr_game.db
# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—É—é –±–∞–∑—É
```

3. **CORS –æ—à–∏–±–∫–∏:**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `CORS_ORIGIN` –≤ `.env`
   - –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –¥–æ–º–µ–Ω –∫–ª–∏–µ–Ω—Ç–∞ –≤–∫–ª—é—á–µ–Ω

### –õ–æ–≥–∏ –æ—à–∏–±–æ–∫

–í—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º:
```
‚ùå [Component] –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏: –¥–µ—Ç–∞–ª–∏
```

## ü§ù –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º

### useWebSocket Hook
```typescript
const {
  isConnected,
  joinRoom,
  sendPlayerMove,
  updateGameState
} = useWebSocket({
  userId: user.id,
  roomId: roomId,
  autoConnect: true
});
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- `MultiplayerMenu` - –°–æ–∑–¥–∞–Ω–∏–µ/–ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–∞–º
- `MultiplayerLobby` - –õ–æ–±–±–∏ —Å –∏–≥—Ä–æ–∫–∞–º–∏
- `PlayerStats` - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **SQLite** - –ë—ã—Å—Ç—Ä–∞—è –ª–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **Socket.io** - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π WebSocket —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç
- **Memory Management** - –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç
- **–ò–Ω–¥–µ–∫—Å—ã –ë–î** - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

---

## ‚≠ê –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

‚úÖ –ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä –¥–æ 8 –∏–≥—Ä–æ–∫–æ–≤  
‚úÖ –°–∏—Å—Ç–µ–º–∞ –∫–æ–º–Ω–∞—Ç —Å –∫–æ–¥–∞–º–∏  
‚úÖ WebSocket —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è  
‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏  
‚úÖ –†–µ–π—Ç–∏–Ω–≥–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞  
‚úÖ –°–∏—Å—Ç–µ–º–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π  
‚úÖ –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –∫–æ–º–Ω–∞—Ç  
‚úÖ RESTful API  
‚úÖ Telegram WebApp –ø–æ–¥–¥–µ—Ä–∂–∫–∞  

üéØ **–ì–æ—Ç–æ–≤ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É!**
